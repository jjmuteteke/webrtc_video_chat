"use strict";angular.module("publicApp",["ngRoute"]).config(["$routeProvider",function(a){a.when("/room/:roomId",{templateUrl:"views/room.html",controller:"RoomCtrl"}).when("/room",{templateUrl:"views/room.html",controller:"RoomCtrl"}).when("/lobby",{templateUrl:"views/lobby.html",controller:"LobbyCtrl"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl"}).otherwise({redirectTo:"/lobby"})}]),angular.module("publicApp").constant("config",{SIGNALIG_SERVER_URL:void 0}),Object.setPrototypeOf=Object.setPrototypeOf||function(a,b){return a.__proto__=b,a},angular.module("publicApp").factory("VideoStream",["$q",function(a){var b;return{get:function(){if(b)return a.when(b);var c=a.defer();return navigator.getUserMedia({video:!0,audio:!0},function(a){b=a,c.resolve(b)},function(a){c.reject(a)}),c.promise}}}]),angular.module("publicApp").factory("Io",function(){if("undefined"==typeof io)throw new Error("Socket.io required");return io}),angular.module("publicApp").controller("RoomCtrl",["$sce","VideoStream","$location","$routeParams","$scope","Room",function(a,b,c,d,e,f){if(!window.RTCPeerConnection||!navigator.getUserMedia)return void(e.error="WebRTC is not supported by your browser. You can try the app with Chrome and Firefox.");var g;b.get().then(function(a){g=a,f.init(g),g=URL.createObjectURL(g),d.roomId?f.joinRoom(d.roomId):f.createRoom().then(function(a){c.path("/room/"+a)})},function(){e.error="No audio/video permissions. Please refresh your browser and allow the audio/video capturing."}),e.peers=[],f.on("peer.stream",function(a){console.log("Client connected, adding new stream"),e.peers.push({id:a.id,stream:URL.createObjectURL(a.stream)})}),f.on("peer.disconnected",function(a){console.log("Client disconnected, removing stream"),e.peers=e.peers.filter(function(b){return b.id!==a.id})}),e.getLocalVideo=function(){return a.trustAsResourceUrl(g)},console.log("test")}]),angular.module("publicApp").factory("Room",["$rootScope","$q","Io","config",function(a,b,c,d){function e(b){if(m[b])return m[b];var c=new RTCPeerConnection(l);return m[b]=c,c.addStream(k),c.onicecandidate=function(a){n.emit("msg",{by:i,to:b,ice:a.candidate,type:"ice"})},c.onaddstream=function(c){console.log("Received new stream"),p.trigger("peer.stream",[{id:b,stream:c.stream}]),a.$$digest||a.$apply()},c}function f(a){var b=e(a);b.createOffer(function(c){b.setLocalDescription(c),console.log("Creating an offer for",a),n.emit("msg",{by:i,to:a,sdp:c,type:"sdp-offer"})},function(a){console.log(a)},{mandatory:{offerToReceiveVideo:!0,offerToReceiveAudio:!0}})}function g(a){var b=e(a.by);switch(a.type){case"sdp-offer":b.setRemoteDescription(new RTCSessionDescription(a.sdp),function(){console.log("Setting remote description by offer"),b.createAnswer(function(c){b.setLocalDescription(c),n.emit("msg",{by:i,to:a.by,sdp:c,type:"sdp-answer"})},function(a){console.log(a)})},function(a){console.log(a)});break;case"sdp-answer":b.setRemoteDescription(new RTCSessionDescription(a.sdp),function(){console.log("Setting remote description by answer")},function(a){console.error(a)});break;case"ice":a.ice&&(console.log("Adding ice candidates"),b.addIceCandidate(new RTCIceCandidate(a.ice)))}}function h(b){b.on("peer.connected",function(a){f(a.id)}),b.on("peer.disconnected",function(b){p.trigger("peer.disconnected",[b]),a.$$digest||a.$apply()}),b.on("msg",function(a){g(a)})}var i,j,k,l={iceServers:[{url:"stun:stun.l.google.com:19302"}]},m={},n=c.connect(d.SIGNALIG_SERVER_URL),o=!1,p={joinRoom:function(a){o||(n.emit("init",{room:a},function(a,b){i=b,j=a}),o=!0)},createRoom:function(){var a=b.defer();return n.emit("init",null,function(b,c){a.resolve(b),j=b,i=c,o=!0}),a.promise},init:function(a){k=a}};return EventEmitter.call(p),Object.setPrototypeOf(p,EventEmitter.prototype),h(n),p}]),angular.module("publicApp").directive("videoPlayer",["$sce",function(a){return{template:'<div><video ng-src="{{trustSrc()}}" autoplay></video></div>',restrict:"E",replace:!0,scope:{vidSrc:"@"},link:function(b){console.log("Initializing video-player"),b.trustSrc=function(){return b.vidSrc?a.trustAsResourceUrl(b.vidSrc):void 0}}}}]),angular.module("publicApp").controller("LobbyCtrl",["$location","$scope",function(a,b){b.val=!1,b.randomR=function(){a.path("/room")},b.joinR=function(){var c=b.textValue;void 0==c?b.val=!b.val:a.path("/room/"+c)}}]),angular.module("publicApp").controller("AboutCtrl",function(){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}),angular.module("publicApp").run(["$templateCache",function(a){a.put("views/about.html","<p>This project was created by the magnificent JJ for part two of the distributed computing end of the semester project.</p>"),a.put("views/lobby.html",'<div id="roomselection"> <h1>KSU video Chat</h1> <div id="roominput"> <input type="text" id="textinput" ng-model="textValue"> <label for="textinput" id="textinput-label" hidden ng-show="val"> </label> </div> <div id="buttonchoice"> <button id="join" ng-click="joinR()"> Join </button> <a href="/#/room"><button id="random"> Random </button></a> </div> </div>'),a.put("views/main.html",'<div class="jumbotron"> <h1>\'Allo, \'Allo!</h1> <p class="lead"> <img src="images/yeoman.8cb970fb.png" alt="I\'m Yeoman"><br> Always a pleasure scaffolding your apps. </p> <p><a class="btn btn-lg btn-success" ng-href="#/">Splendid!<span class="glyphicon glyphicon-ok"></span></a></p> </div> <div class="row marketing"> <h4>HTML5 Boilerplate</h4> <p> HTML5 Boilerplate is a professional front-end template for building fast, robust, and adaptable web apps or sites. </p> <h4>Angular</h4> <p> AngularJS is a toolset for building the framework most suited to your application development. </p> <h4>Karma</h4> <p>Spectacular Test Runner for JavaScript.</p> </div>'),a.put("views/room.html",'<div style="padding: 17px; padding-top: 0px"> <span ng-hide="error"> Allow the browser to use your web cam and after that share the URL from the address bar with the people you want to talk with. </span> <br> <span ng-bind="error"></span> </div> <div class="video-wrapper"> <video-player class="col-md-4" ng-repeat="peer in peers" vid-src="{{peer.stream}}"></video-player> </div> <div class="video-wrapper"> <div class="col-md-2"> <video ng-src="{{getLocalVideo()}}" autoplay muted></video> </div> </div>')}]);